import { inject, Injectable } from '@angular/core';
import { ApiService } from '../../core/services/api.service';
import { Observable } from 'rxjs';

export interface ReservaGastronomiaDto {
  id?: number;
  usuarioId?: string;
  establecimientoId?: number;
  mesaId?: number;
  fecha: string;
  numeroPersonas: number;
  estado?: string;
  total?: number;
  establecimientoNombre?: string;
  clienteNombre?: string;
  mesaNumero?: number;
}

@Injectable({ providedIn: 'root' })
export class ReservasGastronomiaService {
  private readonly api = inject(ApiService);

  /** Listar reservas del cliente autenticado */
  listByCliente(clienteId: string): Observable<ReservaGastronomiaDto[]> {
    return this.api.get<ReservaGastronomiaDto[]>(`/ReservasGastronomia/cliente/${clienteId}`);
  }

  /** Reservas activas del cliente/oferente autenticado */
  activas(params?: { establecimientoId?: number; clienteId?: string }): Observable<ReservaGastronomiaDto[]> {
    const q: any = {};
    if (params?.establecimientoId) q.establecimientoId = params.establecimientoId;
    if (params?.clienteId) q.clienteId = params.clienteId;
    return this.api.get<ReservaGastronomiaDto[]>('/ReservasGastronomia/activas', q);
  }

  /** Historial de reservas del cliente/oferente autenticado */
  historial(params?: { establecimientoId?: number; clienteId?: string }): Observable<ReservaGastronomiaDto[]> {
    const q: any = {};
    if (params?.establecimientoId) q.establecimientoId = params.establecimientoId;
    if (params?.clienteId) q.clienteId = params.clienteId;
    return this.api.get<ReservaGastronomiaDto[]>('/ReservasGastronomia/historial', q);
  }

  /** Cambiar estado de reserva */
  cambiarEstado(id: number, estado: string): Observable<any> {
    return this.api.patch(`/ReservasGastronomia/${id}/estado`, { estado });
  }

  /** Cancelar reserva */
  cancelar(id: number): Observable<any> {
    return this.cambiarEstado(id, 'Cancelada');
  }

  /** Confirmar reserva (oferente) */
  confirmar(id: number): Observable<any> {
    return this.cambiarEstado(id, 'Confirmada');
  }
}
